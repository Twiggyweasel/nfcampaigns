<%= render 'shared/title', title: 'Payment Information', display: 4 %>
<%= form_for [@event, @context, @payment] do |f| %>

  <% if @payment.errors.any? %>
    <%= render 'shared/errors', errors: @payment.errors %>
  <% end %> 

<div class='row'>

  <div class='col-6 offset-1'>
    <div class='card card-block'>
      <h3>Billing Details</h3>
      <div class='row my-3'>
        <div class='col-6'>
          <%= f.label :first_name, class: "control-label" %>
          <%= f.text_field :first_name, class: "form-control" %>
        </div>
        <div class='col-6'>
          <%= f.label :last_name, class: "control-label" %>
          <%= f.text_field :last_name,class: "form-control" %>          
        </div>
      </div>
      <div class="row my-3">
        <div class='col-12'>
          <%= f.label :credit_card_number, class: "control-label" %>
          <%= f.text_field :credit_card_number, class: "form-control" %>          
        </div>
      </div>
      <div class="row my-3">
        <div class='col-4'>
          <%= f.label :expiration_month, class: "control-label" %>
          <%= f.select :expiration_month, months, {}, class: "form-control" %>
        </div>  
        <div class='col-4'>
          <%= f.label :expiration_year, class: "control-label" %>
          <%= f.select :expiration_year, years, {}, class: "form-control" %>          
        </div>  
        <div class='col-4'>
          <%= f.label :card_security_code, class: "control-label" %>
          <%= f.text_field :card_security_code, class: "form-control" %>          
        </div>  
      </div>
      <label class="custom-control custom-checkbox">
  <input type="checkbox" class="custom-control-input" id='cover-fee' checked>
  <span class="custom-control-indicator"></span>
  <span class="custom-control-description">Cover the Processing Fees of <%= number_to_currency(@payment.fee(@context.amount)) %></span>
</label>
        <div class="form-group">
          <%= f.hidden_field(:amount, :value => (@context.amount + @payment.fee(@context.amount))) %> 
        </div>
        <div class="form-group">

        </div>

    </div>
  </div>
  
  <% if @context.instance_of? Contribution %>
  <div class='col-md-4'>
  <div class='card'>
    <div class='card-block'>
      <h2><i class='fa fa-shopping-cart'></i> Cart Information</h2>
      <table class='table'>
        <thead>
          <tr>
            <th>Type</th>
            <th>Count</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Contribution</td>
            <td>1x</td>
            <td><%= number_to_currency(@context.amount) %></td>
          </tr>
           <tr id='processing-block'>
                <td>Cover Processing Fee:</td>
                <td id='processing-count'>x1</td>
                <td id='processing-amount'><%= number_to_currency(@payment.fee(@context.amount)) %></td>
            </tr>
            <tr>
              <td colspan=2>Total:</td>
              <td id='final-total'><%= number_to_currency((@context.amount + @payment.fee(@context.amount))) %></td>
            </tr>
        </tbody>
        </table>

    </div>
            <div class='card-footer'>  
          <%= f.submit "Authorize Card", class: "btn btn-success btn-block" %>
          <%= link_to "Edit Contribution Details", edit_event_contribution_path(@context.backable_id, @context), class: 'btn btn-primary btn-block' %>
        </div>
  </div>
  </div>
  <% else %>
      <div class='col-md-4'>
      <div class='card'>
        <div class='card-block'>
          <h2><i class='fa fa-shopping-cart'></i> Cart Information</h2>
          <table class='table'>
            <thead>
              <tr>
                <th>Type</th>
                <th>Count</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Single Registration</td>
                <td>x1</td>
                <td><%= number_to_currency(@context.fee) %></td>
              </tr>
              <tr>
                <td>Guests</td>
                <td id='guest-count'>x<%= @context.guests.count %></td>
                <td id='guest-total'><%= number_to_currency(@context.guests_fee_total) %></td>
              </tr>
              <tr id='processing-block'>
                <td>Cover Processing Fee:</td>
                <td id='processing-count'>x1</td>
                <td id='processing-amount'><%= number_to_currency(@payment.fee(@context.amount)) %></td>
              </tr>
              <tr>
                <td colspan=2>Total:</td>
                <td id='final-total'><%= number_to_currency((@context.attendee_total + @payment.fee(@context.amount))) %></td>
              </tr>
            </tbody>
          </table>
          

        </div>
        <div class='card-footer'>  
          <%= f.submit "Authorize Card", class: "btn btn-success btn-block" %>
          <%= link_to "Edit Registration Details", edit_event_attendee_path(@context.event, @context), class:'btn btn-primary btn-block' %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<% end %>

<script>
 $('#cover-fee').click(function() {
   
   var amountwfeeRaw = <%= @context.amount + @payment.fee(@context.amount) %>;
   var amountRaw = <%= @context.amount %>
   var feeClean = "<%= number_to_currency(@payment.fee(@context.amount)).to_s %>";
   var total =  "<% if @context.instance_of? Contribution %><%= number_to_currency(@context.amount).to_s %><% else %><%= number_to_currency(@context.attendee_total).to_s %><% end %>"
   var totalwfee = "<% if @context.instance_of? Contribution %><%= number_to_currency(@payment.fee(@context.amount) + @context.amount).to_s %><% else %><%= number_to_currency(@payment.fee(@context.amount) + @context.attendee_total).to_s %><% end %>"
   
   
      if($(this).is(":checked")) {
        console.log("checked");
        // $('#processing-block').show();
        $('#processing-count').text('x1')
        $('#processing-amount').text(feeClean);
        $('#final-total').text(totalwfee);
        $('#payment_amount').val(amountwfeeRaw);
      } else {
        console.log('not checked');
        // $('#processing-block').hide(); 
        $('#processing-count').text('x0');
        $('#processing-amount').text('$0.00');
        $('#final-total').text(total);
        $('#payment_amount').val(amountRaw); 
      }
  });
  
</script>