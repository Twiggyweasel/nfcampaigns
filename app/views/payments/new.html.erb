<%= render 'shared/title', title: 'Payment Information', display: 4 %>
<%= form_for [@event, @context, @payment] do |f| %>

  <% if @payment.errors.any? %>
    <%= render 'shared/errors', errors: @payment.errors %>
  <% end %> 

<div class='row mb-3'>

  <div class='col-6 offset-1'>
    <div class='card card-block'>
      <h3><i class="fa fa-credit-card" aria-hidden="true"></i> Credit Card</h3>
      <div class='row my-3'>
        <div class='col-6'>
          <%= f.label :first_name %>
          <%= f.text_field :first_name, class: "form-control" %>
        </div>
        <div class='col-6'>
          <%= f.label :last_name %>
          <%= f.text_field :last_name,class: "form-control" %>          
        </div>
      </div>
      <div class="row my-3">
        <div class='col-12'>
          <%= f.label :credit_card_number %>
          <%= f.text_field :credit_card_number, class: "form-control" %>          
        </div>
      </div>
      <div class="row my-3">
        <div class='col-4'>
          <%= f.label :expiration_month %>
          <%= f.select :expiration_month, months, {}, class: "form-control" %>
        </div>  
        <div class='col-4'>
          <%= f.label :expiration_year %>
          <%= f.select :expiration_year, years, {}, class: "form-control" %>          
        </div>  
        <div class='col-4'>
          <%= f.label :card_security_code %>
          <%= f.text_field :card_security_code, class: "form-control" %>          
        </div>  
      </div>
      <div class='row my-3'>
        <div class='col-12'>
          <label class="custom-control custom-checkbox">
            <%= f.check_box :cover_processing, class: 'custom-control-input', checked: true %>
            <!--<input type="checkbox" class="custom-control-input" id='cover-fee' checked>-->
            <span class="custom-control-indicator"></span>
            <span class="custom-control-description">Cover the Processing Fees of <%= number_to_currency(@payment.fee(@context.amount).floor2(2)) %></span>
          </label>  
        </div>
      </div>
        <div class="form-group">
          <%= f.hidden_field(:amount, :value => @context.amount) %> 
          <%= f.hidden_field(:promo_code, :value => "") %>
        </div>
    </div>
    

    
    <div class='card card-block mt-3'>
      <h3><i class="fa fa-address-card-o" aria-hidden="true"></i> Billing Address</h3>
      <div class='row my-3'>
        <div class='col-12'>
          <label class="custom-control custom-checkbox">
            <input type="checkbox" class="custom-control-input" id='custom-address'>
            <span class="custom-control-indicator"></span>
            <span class="custom-control-description">Use a different address</span>
          </label>  
        </div>
      </div>
      <div class='row my-3'>
        <div class='col-6'>
          <%= f.label :street, "Street Address" %>
          <%= f.text_field :street, class: "form-control", :value => current_user.profile.street %>
        </div>
        <div class='col-6'>
          <%= f.label :apt, "Apt/Suite #" %>
          <%= f.text_field :apt,class: "form-control", :value => current_user.profile.apt %>          
        </div>
      </div>
      <div class="row my-3">
        <div class='col-4'>
          <%= f.label :city %>
          <%= f.text_field :city, class: "form-control", :value => current_user.profile.city %>  
        </div>  
        <div class='col-4'>
          <%= f.label :state %>
          <%= f.text_field :state, class: "form-control", :value => current_user.profile.state %> 
        </div>  
        <div class='col-4'>
          <%= f.label :zip, "Zip Code" %>
          <%= f.text_field :zip, class: "form-control", :value => current_user.profile.zipcode %>  
        </div>  
      </div>
    </div>
  </div>
  
  <% if @context.instance_of? Contribution %>
  <div class='col-md-4'>
  <div class='card'>
    <div class='card-block'>
      <h2><i class='fa fa-shopping-cart'></i> Cart</h2>
      <table class='table'>
        <thead>
          <tr>
            <th>Type</th>
            <th>Count</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Contribution</td>
            <td>1x</td>
            <td><%= number_to_currency(@context.amount) %></td>
          </tr>
           <tr id='processing-block'>
                <td>Cover Processing Fee:</td>
                <td id='processing-count'>1x</td>
                <td id='processing-amount'><%= number_to_currency(@payment.fee(@context.amount).floor2(2)) %></td>
            </tr>
            <tr>
              <td colspan=2>Total:</td>
              <td id='final-total'><%= number_to_currency((@context.amount + @payment.fee(@context.amount)).floor2(2)) %></td>
            </tr>
        </tbody>
        </table>

    </div>
            <div class='card-footer'>  
            <input type='number' value='<%= (@context.amount + @payment.fee(@context.amount)).floor2(2) %>' id='hidden_total_fee' style='display: none;'>
        <input type='number' value='<%= @context.amount.floor2(2) %>' id='hidden_total' style='display: none;'>
        <input type='number' value='<%= @payment.fee(@context.amount).floor2(2) %>' id='hidden_fee' style='display: none;'>
          <%= f.submit "Authorize Card", class: "btn btn-success btn-block" %>
          <%= link_to "Edit Contribution Details", edit_event_contribution_path(@context.backable_id, @context), class: 'btn btn-primary btn-block' %>
        </div>
  </div>
  </div>
  <% else %>
      <div class='col-md-4'>
      <div class='card'>
        <div class='card-block'>
          <h2><i class='fa fa-shopping-cart'></i> Cart</h2>
          <table class='table'>
            <thead>
              <tr>
                <th>Type</th>
                <th>Count</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Single Registration</td>
                <td>x1</td>
                <td><%= number_to_currency(@context.fee) %></td>
              </tr>
              <tr>
                <td>Guests</td>
                <td id='guest-count'>x<%= @context.guests.count %></td>
                <td id='guest-total'><%= number_to_currency(@context.guests_fee_total) %></td>
              </tr>
              <tr id='processing-block'>
                <td>Cover Processing Fee:</td>
                <td id='processing-count'>x1</td>
                <td id='processing-amount'><%= number_to_currency(@payment.fee(@context.amount).floor2(2)) %></td>
              </tr>
              <tr id='promo-block' style='display: none;'>
                <td id='promo-code-name'></td>
                <td id='promo-percent'></td>
                <td id='promo-discount'></td>
              </tr>
              <tr>
                <td colspan=2>Total:</td>
                <td id='final-total'><%= number_to_currency((@context.attendee_total + @payment.fee(@context.amount)).floor2(2)) %></td>
              </tr>
            </tbody>
          </table>
          

        </div>
        <div class='card-footer'>  
        <input type='number' value='<%= (@context.attendee_total + @payment.fee(@context.amount)).floor2(2) %>' id='hidden_total_fee' style='display: none;'>
        <input type='number' value='<%= @context.attendee_total.floor2(2) %>' id='hidden_total' style='display: none;'>
        <input type='number' value='<%= @payment.fee(@context.amount).floor2(2) %>' id='hidden_fee' style='display: none;'>
          <%= f.submit "Authorize Card", class: "btn btn-success btn-block" %>
          <%= link_to "Edit Registration Details", edit_event_attendee_path(@context.event, @context), class:'btn btn-primary btn-block' %>
        </div>
      </div>
    </div>
  <% end %>
</div>



<% end %>
<% if !@context.instance_of? Contribution %>
  <% if !@context.category === "Corporate" %>
<div class='row mt-3'>
  <div class='col-6 offset-1'>
    <div class='card card-block' id='promo-box'>
      <%= form_for @promo, method: :post, url: check_promotion_code_path, remote: true, :html => { class: 'form-inline' } do |fp| %>
        <%= fp.text_field :code, class: 'form-control mb-2 mr-sm-2 mb-sm-0', :placeholder => "Coupon Code..." %>
        <%= fp.hidden_field(:attendee_id, :value => @context.id) %>
        <%= fp.submit "Submit Coupon", class: 'btn btn-success', id: 'promo-btn' %>
        
      <% end %>
    </div>
  </div>
</div>
<% end %>
<% end %>

<script>
 $('#payment_cover_processing').click(function() {
   
   var amountwfeeRaw = $('#hidden_total_fee').val();
   var amountRaw = $('#hidden_total').val();
   var feeClean = $('#hidden_fee').val();
  // var total =  "<% if @context.instance_of? Contribution %><%= number_to_currency(@context.amount).to_s %><% else %><%= number_to_currency(@context.attendee_total).to_s %><% end %>"
  // var totalwfee = "<% if @context.instance_of? Contribution %><%= number_to_currency(@payment.fee(@context.amount) + @context.amount).to_s %><% else %><%= number_to_currency(@payment.fee(@context.amount) + @context.attendee_total).to_s %><% end %>"
   
   
      if($(this).is(":checked")) {
        var rounded_fee = parseFloat(feeClean).toFixed(2);
        console.log("checked");
        // $('#processing-block').show();
        $('#processing-count').text('x1')
        $('#processing-amount').text("$" + parseFloat(feeClean).toFixed(2));
        $('#final-total').text("$" + parseFloat(amountwfeeRaw).toFixed(2));
        // $('#payment_amount').val(amountwfeeRaw);
      } else {
        console.log('not checked');
        // $('#processing-block').hide(); 
        $('#processing-count').text('x0');
        $('#processing-amount').text('$0.00');
        $('#final-total').text("$" + parseFloat(amountRaw).toFixed(2));
        // $('#payment_amount').val(amountRaw); 
      }
  });
  $('#custom-address').click(function() {
    
    var profile_address = "<%= current_user.profile.street %>"
    var profile_apt = "<%= current_user.profile.apt %>"
    var profile_city = "<%= current_user.profile.city %>"
    var profile_state = "<%= current_user.profile.state %>"
    var profile_zip = "<%= current_user.profile.zipcode %>"
    if($(this).is(":checked")) {
        console.log("checked");
        // $('#processing-block').show();
        $('#payment_street').val('');
        $('#payment_apt').val('');
        $('#payment_city').val('');
        $('#payment_state').val('');
        $('#payment_zip').val('');
        $('#payment_street').focus();
      } else {
        console.log('not checked');
        // $('#processing-block').hide(); 
        $('#payment_street').val(profile_address);
        $('#payment_apt').val(profile_apt);
        $('#payment_city').val(profile_city);
        $('#payment_state').val(profile_state);
        $('#payment_zip').val(profile_zip);
      }
  });
</script>